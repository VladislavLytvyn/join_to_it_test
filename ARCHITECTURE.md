# üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ WebSocket —Å–µ—Ä–≤–µ—Ä–∞ –∑ graceful shutdown.

## üìê –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      FastAPI Application                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ HTTP Endpoints  ‚îÇ    ‚îÇ  WebSocket Endpoint (/ws)    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - GET /        ‚îÇ    ‚îÇ  - Accept connections        ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - GET /health  ‚îÇ    ‚îÇ  - Handle messages           ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ  - Manage lifecycle          ‚îÇ    ‚îÇ
‚îÇ                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ            Connection Manager                        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Track active connections                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Broadcasting mechanism                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Thread-safe operations (asyncio.Lock)             ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ         Graceful Shutdown Manager                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Signal handlers (SIGTERM/SIGINT)                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Shutdown orchestration                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Timeout enforcement (30 min)                      ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ         Background Tasks                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Periodic broadcast (every 10s)                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Shutdown monitoring                               ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

### 1. ConnectionManager

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö**:
```python
active_connections: Dict[str, tuple[WebSocket, float]]
# –ö–ª—é—á: client_id (—É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä)
# –ó–Ω–∞—á–µ–Ω–Ω—è: (websocket, connect_time)
```

**–ú–µ—Ç–æ–¥–∏**:
- `connect()` - –¥–æ–¥–∞—î –Ω–æ–≤–µ –∑'—î–¥–Ω–∞–Ω–Ω—è
- `disconnect()` - –≤–∏–¥–∞–ª—è—î –∑'—î–¥–Ω–∞–Ω–Ω—è
- `broadcast()` - —Ä–æ–∑—Å–∏–ª–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—Å—ñ–º
- `send_personal_message()` - –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- `get_active_count()` - –ø–æ–≤–µ—Ä—Ç–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑'—î–¥–Ω–∞–Ω—å
- `close_all_connections()` - –∑–∞–∫—Ä–∏–≤–∞—î –≤—Å—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è

**Thread Safety**:
```python
self._lock = asyncio.Lock()

async with self._lock:
    # –ö—Ä–∏—Ç–∏—á–Ω–∞ —Å–µ–∫—Ü—ñ—è
    self.active_connections[client_id] = (websocket, time.time())
```

### 2. GracefulShutdownManager

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å–æ–º –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏

**–û—Å–Ω–æ–≤–Ω—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ**:
```python
shutdown_event: asyncio.Event()  # –°–∏–≥–Ω–∞–ª –¥–ª—è –ø–æ—á–∞—Ç–∫—É shutdown
timeout_seconds: int = 1800      # 30 —Ö–≤–∏–ª–∏–Ω
_shutdown_started: bool          # –ü—Ä–∞–ø–æ—Ä–µ—Ü—å –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É
```

**–ú–µ—Ç–æ–¥–∏**:
- `register_signals()` - —Ä–µ—î—Å—Ç—Ä—É—î SIGTERM/SIGINT –æ–±—Ä–æ–±–Ω–∏–∫–∏
- `signal_handler()` - –æ–±—Ä–æ–±–ª—è—î –æ—Ç—Ä–∏–º–∞–Ω—ñ —Å–∏–≥–Ω–∞–ª–∏
- `wait_for_shutdown()` - –æ—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ shutdown

**–ê–ª–≥–æ—Ä–∏—Ç–º shutdown**:
```
1. –û—Ç—Ä–∏–º–∞–Ω–æ —Å–∏–≥–Ω–∞–ª ‚Üí –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ shutdown_event
2. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –≤—Å—ñ–º –∫–ª—ñ—î–Ω—Ç–∞–º
3. LOOP:
   a. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏: –≤—Å—ñ –≤—ñ–¥–∫–ª—é—á–∏–ª–∏—Å—è? ‚Üí EXIT
   b. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏: —Ç–∞–π–º–∞—É—Ç –¥–æ—Å—è–≥–Ω—É—Ç–æ? ‚Üí –ø—Ä–∏–º—É—Å–æ–≤–µ –∑–∞–∫—Ä–∏—Ç—Ç—è ‚Üí EXIT
   c. –õ–æ–≥—É–≤–∞—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å (–∫–æ–∂–Ω—ñ 10s)
   d. –ß–µ–∫–∞—Ç–∏ 1 —Å–µ–∫—É–Ω–¥—É
4. –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–æ–±–æ—Ç—É
```

### 3. WebSocket Endpoint

**Lifecycle**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  New Request ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ shutdown_in_progress
       ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ —è–∫—â–æ –¢–ê–ö ‚Üí –≤—ñ–¥—Ö–∏–ª–∏—Ç–∏ (–∫–æ–¥ 1001)
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ ConnectionManager.connect()
       ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ accept() + –¥–æ–¥–∞—Ç–∏ –¥–æ active_connections
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ —ñ–Ω—à–∏—Ö –ø—Ä–æ –Ω–æ–≤–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ LOOP: –û–±—Ä–æ–±–∫–∞ –≤—Ö—ñ–¥–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
       ‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ websocket.receive_text()
       ‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ –û–±—Ä–æ–±–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
       ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ Broadcasting —ñ–Ω—à–∏–º –∫–ª—ñ—î–Ω—Ç–∞–º
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ Exception handling:
       ‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ WebSocketDisconnect ‚Üí –Ω–æ—Ä–º–∞–ª—å–Ω–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
       ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ Exception ‚Üí –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏
       ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ FINALLY:
            ‚îú‚îÄ‚îÄ‚îÄ ConnectionManager.disconnect()
            ‚îî‚îÄ‚îÄ‚îÄ –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ —ñ–Ω—à–∏—Ö –ø—Ä–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
```

### 4. Periodic Broadcast Task

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Ä–æ–∑—Å–∏–ª–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ

```python
while not shutdown_event.is_set():
    try:
        await asyncio.wait_for(shutdown_event.wait(), timeout=10.0)
        break  # Shutdown –æ—Ç—Ä–∏–º–∞–Ω–æ
    except asyncio.TimeoutError:
        # 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–π—à–ª–æ - –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        await manager.broadcast(periodic_message)
```

## üîÑ –ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö

### –ù–æ—Ä–º–∞–ª—å–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è

```
Client A          Server              Client B
   ‚îÇ                 ‚îÇ                   ‚îÇ
   ‚îú‚îÄ‚îÄ‚îÄ connect ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                   ‚îÇ
   ‚îÇ<‚îÄ‚îÄ welcome ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                   ‚îÇ
   ‚îÇ                 ‚îÇ<‚îÄ‚îÄ‚îÄ connect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ<‚îÄ‚îÄ broadcast ‚îÄ‚îÄ‚îÄ‚î§‚îÄ‚îÄ‚îÄ‚îÄ welcome ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                 ‚îÇ                   ‚îÇ
   ‚îú‚îÄ‚îÄ‚îÄ message ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                   ‚îÇ
   ‚îÇ<‚îÄ‚îÄ ack ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                   ‚îÇ
   ‚îÇ                 ‚îú‚îÄ‚îÄ broadcast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                 ‚îÇ                   ‚îÇ
   ‚îÇ<‚îÄ periodic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÄ‚îÄ‚îÄ periodic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                 ‚îÇ                   ‚îÇ
```

### Graceful Shutdown

```
Client A          Server              Client B
   ‚îÇ                 ‚îÇ                   ‚îÇ
   ‚îÇ    [SIGTERM received]               ‚îÇ
   ‚îÇ                 ‚îÇ                   ‚îÇ
   ‚îÇ<‚îÄ‚îÄ warning ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÄ‚îÄ‚îÄ‚îÄ warning ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                 ‚îÇ                   ‚îÇ
   ‚îÇ                 ‚îÇ [waiting...]      ‚îÇ
   ‚îÇ                 ‚îÇ                   ‚îÇ
   ‚îú‚îÄ‚îÄ‚îÄ close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                   ‚îÇ
   ‚îÇ                 ‚îÇ [1 connection]    ‚îÇ
   ‚îÇ                 ‚îÇ                   ‚îÇ
   ‚îÇ                 ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ                 ‚îÇ [0 connections]   ‚îÇ
   ‚îÇ                 ‚îÇ                   ‚îÇ
   ‚îÇ              [shutdown]              ‚îÇ
```

## üõ°Ô∏è Edge Cases —Ç–∞ –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫

### 1. –ö–ª—ñ—î–Ω—Ç –≤—ñ–¥–∫–ª—é—á–∏–≤—Å—è –ø—ñ–¥ —á–∞—Å broadcast

```python
failed_clients = []
for client_id, (websocket, _) in active_connections.items():
    try:
        await websocket.send_text(message)
    except Exception:
        failed_clients.append(client_id)

# –û—á–∏—Å—Ç–∫–∞
for client_id in failed_clients:
    await self.disconnect(client_id)
```

### 2. Race condition –ø—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ–º—É –¥–æ—Å—Ç—É–ø—ñ

```python
# ‚ùå –ù–ï–ë–ï–ó–ü–ï–ß–ù–û
active_count = len(self.active_connections)  # –ß–∏—Ç–∞–Ω–Ω—è
del self.active_connections[client_id]       # –ó–∞–ø–∏—Å

# ‚úÖ –ë–ï–ó–ü–ï–ß–ù–û
async with self._lock:
    active_count = len(self.active_connections)
    del self.active_connections[client_id]
```

### 3. –ù–æ–≤–µ –∑'—î–¥–Ω–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å shutdown

```python
if shutdown_manager.shutdown_event.is_set():
    await websocket.close(code=1001, reason="–°–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à—É—î —Ä–æ–±–æ—Ç—É")
    return
```

### 4. –¢–∞–π–º–∞—É—Ç –¥–æ—Å—è–≥–Ω—É—Ç–æ –∑ –∞–∫—Ç–∏–≤–Ω–∏–º–∏ –∫–ª—ñ—î–Ω—Ç–∞–º–∏

```python
if elapsed_time >= self.timeout_seconds:
    logger.warning("–¢–∞–π–º–∞—É—Ç –¥–æ—Å—è–≥–Ω—É—Ç–æ. –ü—Ä–∏–º—É—Å–æ–≤–µ –∑–∞–∫—Ä–∏—Ç—Ç—è...")
    await self.connection_manager.close_all_connections()
    break
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Ç–∞ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### Environment Variables (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

```python
import os

SHUTDOWN_TIMEOUT = int(os.getenv("SHUTDOWN_TIMEOUT", 1800))
BROADCAST_INTERVAL = int(os.getenv("BROADCAST_INTERVAL", 10))
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ Uvicorn

```bash
uvicorn main:app \
  --host 0.0.0.0 \
  --port 8000 \
  --workers 1 \              # ‚ö†Ô∏è –û–±–æ–≤'—è–∑–∫–æ–≤–æ 1!
  --timeout-keep-alive 3600 \ # –î–ª—è –¥–æ–≤–≥–∏—Ö –∑'—î–¥–Ω–∞–Ω—å
  --limit-concurrency 1000    # –ú–∞–∫—Å–∏–º—É–º –∑'—î–¥–Ω–∞–Ω—å
```

## üìä Performance Considerations

### –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è

**–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è** (workers=1):
```
‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó
‚úÖ –ü—Ä–∞—Ü—é—î graceful shutdown
‚ùå –û–±–º–µ–∂–µ–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (1 –ø—Ä–æ—Ü–µ—Å)
```

**–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è** (–∫—ñ–ª—å–∫–∞ —ñ–Ω—Å—Ç–∞–Ω—Å—ñ–≤):
```
‚úÖ –í–∏—Å–æ–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
‚úÖ Fault tolerance
‚ö†Ô∏è –ü–æ—Ç—Ä–µ–±—É—î —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —Å—Ö–æ–≤–∏—â–µ (Redis/RabbitMQ)
```

### Memory Usage

```python
# –ü—Ä–∏–±–ª–∏–∑–Ω–∞ –æ—Ü—ñ–Ω–∫–∞ –ø–∞–º'—è—Ç—ñ –Ω–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è
per_connection = (
    WebSocket object: ~2KB +
    Buffers: ~8KB +
    Connection metadata: ~1KB
) ‚âà 11KB

# –î–ª—è 10,000 –∑'—î–¥–Ω–∞–Ω—å:
10,000 * 11KB ‚âà 110MB
```

### CPU Usage

- **Idle**: ~0-1% (–ª–∏—à–µ periodic tasks)
- **Broadcasting**: O(n) –¥–µ n = –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–ª—ñ—î–Ω—Ç—ñ–≤
- **Shutdown**: O(n) –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –≤—Å—ñ—Ö –∑'—î–¥–Ω–∞–Ω—å

## üîê –ë–µ–∑–ø–µ–∫–∞

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

1. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è**:
```python
@app.websocket("/ws/{client_id}")
async def websocket_endpoint(websocket: WebSocket, client_id: str, token: str):
    if not verify_token(token):
        await websocket.close(code=1008, reason="Unauthorized")
        return
```

2. **Rate Limiting**:
```python
# –û–±–º–µ–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥ –∫–ª—ñ—î–Ω—Ç–∞
MAX_MESSAGES_PER_MINUTE = 60
```

3. **Input Validation**:
```python
# –í–∞–ª—ñ–¥–∞—Ü—ñ—è client_id
import re
if not re.match(r'^[a-zA-Z0-9_-]+$', client_id):
    await websocket.close(code=1003, reason="Invalid client ID")
    return
```

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### Unit Tests

```python
import pytest
from main import ConnectionManager

@pytest.mark.asyncio
async def test_connection_manager():
    manager = ConnectionManager()
    # Mock WebSocket
    ws = MockWebSocket()
    
    await manager.connect(ws, "test_client")
    assert manager.get_active_count() == 1
    
    await manager.disconnect("test_client")
    assert manager.get_active_count() == 0
```

### Integration Tests

```python
from fastapi.testclient import TestClient
from main import app

def test_websocket():
    client = TestClient(app)
    with client.websocket_connect("/ws/test") as websocket:
        data = websocket.receive_text()
        assert "–í—ñ—Ç–∞—î–º–æ" in data
```

## üìà –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –ú–µ—Ç—Ä–∏–∫–∏

### –ö–ª—é—á–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏

1. **active_connections** - –ø–æ—Ç–æ—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑'—î–¥–Ω–∞–Ω—å
2. **total_messages_sent** - –≤—Å—å–æ–≥–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
3. **shutdown_duration** - —á–∞—Å –Ω–∞ graceful shutdown
4. **failed_broadcasts** - –Ω–µ–≤–¥–∞–ª—ñ —Å–ø—Ä–æ–±–∏ broadcast

### –õ–æ–≥—É–≤–∞–Ω–Ω—è

```python
# –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
logger.info(
    "Connection event",
    extra={
        "client_id": client_id,
        "event": "connect",
        "total_connections": manager.get_active_count()
    }
)
```

---

**–¶—è –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞–±–µ–∑–ø–µ—á—É—î –Ω–∞–¥—ñ–π–Ω—É, –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—É —Ç–∞ –ª–µ–≥–∫–æ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—É —Å–∏—Å—Ç–µ–º—É WebSocket –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó.** üöÄ

